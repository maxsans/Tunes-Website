name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: tunes-website
  DOCKER_TAG: ${{ github.sha }}

jobs:
  # CI step - Tests and Build
  continuous-integration:
    name: CI - Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run linter
        run: npm run lint --if-present

      - name: ğŸ§ª Run tests
        run: npm test --if-present -- --coverage --watchAll=false --passWithNoTests

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 1

  # CD step - Docker Build and Deploy
  continuous-deployment:
    name: CD - Docker & Deploy
    runs-on: ubuntu-latest
    needs: continuous-integration
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸš€ Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting deployment process..."

            # Create deployment directory
            mkdir -p ~/deployments/tunes-website
            cd ~/deployments/tunes-website

            # Download docker-compose file
            echo "ğŸ“¥ Downloading docker-compose configuration..."
            curl -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o docker-compose.yml \
                 -L "https://api.github.com/repos/${{ github.repository }}/contents/docker/docker-compose.yml"

            # Stop existing container gracefully
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down --timeout 30 || echo "No existing containers to stop"

            # Pull latest image
            echo "ğŸ“¦ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest

            # Start new container with production config
            echo "ğŸ³ Starting new containers..."
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }} DOCKER_IMAGE=${{ env.DOCKER_IMAGE }} docker-compose -f docker-compose.prod.yml up -d

            # Wait for container to be ready
            echo "â³ Waiting for application to start..."
            sleep 20

            # Verify deployment
            if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ Application is running in proxy network"
              
              # Test health endpoint via container
              if docker exec tunes-website wget --spider -q http://localhost/health; then
                echo "ğŸ’š Health check passed!"
              else
                echo "âš ï¸ Health check failed, but container is running"
              fi
              
              # Show container status
              echo "ğŸ“Š Container status:"
              docker-compose -f docker-compose.prod.yml ps
            else
              echo "âŒ Deployment failed!"
              echo "ğŸ“‹ Container logs:"
              docker-compose -f docker-compose.prod.yml logs --tail 50
              exit 1
            fi

            # Cleanup old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "ğŸ‰ Deployment completed successfully!"

      - name: ğŸ“¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production server completed successfully!"
            echo "ğŸŒ Application is live at https://tunes-app.com"
          else
            echo "âŒ Deployment failed. Please check the logs above."
          fi
